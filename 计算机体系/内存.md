```
低 ---> 高
text段 bss段 data段 堆(heap)        栈(stack)

逻辑地址 —— 线性地址 —— 物理地址

malloc分配的是虚拟内存，只有当你访问时，会发生缺页异常，然后内核就会分配物理页帧到虚拟页上。

```

## 虚拟内存
### 概念
```
https://www.cnblogs.com/panchanggui/p/9288389.html

虚拟内存被组织为一个由存放在磁盘上的N个连续的字节大小的单元组成的数组
虚拟内存被分割为虚拟页（VP，页），物理内存也被分割为物理页（PP,页帧）

虚拟内存的结构存储在磁盘上，因为程序可以申请很多的虚拟内存

//包含三个不相交的子集
未分配的：未分配和创建的页，不占任何磁盘空间
缓存的：已缓存的在物理内存中已分配的页
未缓存的：未缓存的在物理内存中已分配的页

未分配表示：表示没有任何数据和他们相关联，不占任何磁盘空间
缓存表示：映射到物理内存的虚拟内存

//已分配还没有缓存
```

### 进程地址空间
```
虚拟地址空间，只有自身一个进程，无法感知其他的存在。

0           TASK_SIZE       2^32或2^64
    用户空间     |       内核空间   

只读段(text, rodata)|读写段(data, bss)|堆(malloc)|...|共享库存储器映射区域|...|栈|内核

1. 每个进程都有自己独立的4G虚拟内存空间，各个进程的内存空间具有类似的结构
2. 一个新进程建立的时候，将会建立起自己的内存空间，此进程的数据，代码等从磁盘拷贝到自己的进程空间，哪些数据在哪里，都由进程控制表中的task_struct记录，task_struct中记录中一条链表，记录中内存空间的分配情况，哪些地址有数据，哪些地址无数据，哪些可读，哪些可写，都可以通过这个链表记录
3. 每个进程已经分配的内存空间，都与对应的磁盘空间映射


```

### 物理和虚拟内存寻址
```
       VA                  PA
cpu -----------> MMU --------------> [][][][][][][]
    虚拟地址   地址翻译     物理地址     物理主存

cpu芯片上有内存管理单元专用硬件，利用存放在主存中的查询表来动态翻译虚拟地址
```

### 页表
```
用来将虚拟地址空间映射到物理地址空间的数据结构称为页表

因为虚拟地址空间大部分没有使用，

//多级页表
PGD ------> PMD -----> PTE --> offset
全局页表    中间页表    页表     页帧

```

### 缺页异常
```
缺页异常的原因有以下几种： 
1、导致缺页异常的线性地址根本不在进程的“虚存区间”中，段错误。（栈扩展是一种例外情况）
2、地址在“虚存区间”中，但“虚存区间”的访问权限不够；例如“区间”是只读的，而你想写，段错误
3、权限也够了，但是映射关系没建立；先建立映射关系再说
4、映射关系也建立了，但是页面不在内存中。肯定是换出到交换分区中了，换进来再说
5、页面也在内存中。但页面的访问权限不够。例如页面是只读的，而你想写。这通常就是 “写时拷贝COW” 的情况。
6、缺页异常发生在“内核动态映射空间”。这是由于进程进入内核后，访问一个通过 vmalloc() 获得线性地址而引起的异常。对这种情况，需要将内核页目录表、页表中对应的映射关系拷贝到进程的页目录表和页表中。
```