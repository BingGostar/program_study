### 表格系统特点
```
分布式表格系统对外提供表格模型，每个表格由很多行组成，通过主键唯一标识，每一行包含很多列。整个表格在系统中全局有序
```

### Google Bigtable
```
Bigtable是Google开发的基于GFS和Chubby的分布式表格系统

1、存储模型
    Bigtable是一个稀疏的、分布式的、持久化存储多维度排序Map
    Map的索引是行关键字 、列关键字以及时间戳
    Map中的每个value都是一个未经解析的byte数组

    key ---> value                                         
    (row:string,column:string,timestamp:int64) ---> string
    
    // 实例
        存储网页数据(Webtable)
        使用URL作为行关键字，使用网页的某些属性作为列关键字
        '行名(行关键字)'是反向URL
        'contents列族'存放网页的内容，并用时间戳做标识
        'anchor列族'存放引用该网页的锚链接文本

        URL             'contents:'     'anchor:cnnsi.com'  'anchor:my.look.ca'
        +-------------+----------------+-------------------+--------------------+
        |'com.cnn.www'|  '<html>' <-t6 |  'CNN' <-t8       |  'CNN.com' <-t5    | 
        |             |  '<html>' <-t5 |                   |                    | 
        |             |  '<html>' <-t4 |                   |                    |     
        +-------------+----------------+-------------------+--------------------+


    > 行
        > 原子性
            对同一行的读或写都是原子的(不管读或写这一行有多少不同的列)
        > 顺序性
            通过行关键字的字典顺序来组织数据
        > Tablet
            表中的每一行都可以动态分区
            每个分区叫做一个'Tablet'
        > Tablet功能
            Tablet是'数据分布和负载均衡'调整的最小单位
            优点：操作只读取行中很少几列的数据效率很高，需要很少的机器通信
            例如：Webtable中，反转URL可以把同一域名下的网页'聚'集起来组成'连续的行'

    > 列族
        列关键字组成的集合叫做列族，列族是Bigtable中访问控制的基本单元
        > 同一种类型
            同一列族同一种类型(利于压缩)
        > 列族的稳定性
            使用前要先创建，而且不能太多(几百个)，很少改变比较固定
        > 无限个列
            列族创建后，在其下可以创建无限个列
        > 列关键字
            列族:限定字
        > 功能
            '访问控制、磁盘和内存的使用统计'都是在列族层面进行的
   
   > 时间戳
        > 版本
            每一个数据项都包含不同的版本，不同的版本利用时间戳来索引
        > 倒序
            时间戳是64位整型，倒序排序，最新的数据排在最前面
        > 删除冗余
            可以指定只保存'最后n个版本'或者只保存'一定时间的数据'

    > 事务性
        > 单行上的事务处理
            BigTable对'一行'关键字下的数据操作具有事务性(进行原子性的读-更新-写操作)
        > 不支持跨行事务
        > 允许把数据项用做整数计数器

2、架构
    BigTable由Client、Master、Tablet Server构成
    BigTable是构建在google基础组件上的。例如集群调度系统用来故障恢复与监控；GFS用来存储日志及子表SSTable数据；Chubby锁服务用来存储元数据执行Master选举
    (1) Client
        > 提供API
            提供Bigtable到应用程序的接口，对表格的数据单元进行增、删、查、改等操作
        > 与字表服务器直接通信    
            客户端通过Chubby锁服务获取一些控制信息，但所有表格的数据内容都在客户端与子表服务器之间直接传送
    (2) Master
        管理所有的子表服务器
        > 分配子表给子表服务器
        > 指导子表服务器实现子表的合并
        > 接受来自子表服务器的子表分裂消息
        > 监控子表服务器，在子表服务器之间进行负载均衡并实现子表服务器的故障恢复等
    (3) Tablet Server
        > 子表的操作
            实现子表的装载/卸出、表格内容的读和写，子表的合并和分裂
        > 日志的操作
            Tablet Server操作日志，存储在GFS上
        > 数据的操作
            Tablet Server服务操作每个子表上的sstable数据，这些数据存储在底层的GFS中
    (4) Chubby锁服务
            > 主控服务器选取
                选取并保证同一时间内只有一个主控服务器
            > 存储Bigtable系统引导信息
            > 用于配合主控服务器发现子表服务器加入和下线
            > 获取Bigtable表格的schema信息及访问控制信息
            > Chubby服务部署在多个数据中心，典型的部署为两地三数据中心五副本，同城的两个数据中心分别部署两个副本，异地的数据中心部署一个副本，任何一个数据中心整体发生故障都不影响正常服务
    (5) SSTable
        BigTable内部数据存储是的文件是SSTable格式的
        > Map结构
            SSTable是一个持久化、排序的、不可更改的Map结构(key-value)
            查询与一个 key 值相关的 value,或者遍历某个 key 值范围内的所有的 key-value 对
        > 数据块
            SSTable 是一系列的数据块(64KB)
            SSTable 使用块索引来定位数据块
            在打开 SSTable 的时候,索引被加载到内存
        > 数据查找
            每次查找都可以通过一次磁盘搜索完成
            首先使用二分查找法在内存中的索引里找到数据块的位置, 然后再从硬盘读取相应的数据块
            也可以选择把整个 SSTable 都放在内存中,这样就不必访问硬盘了





BigTable 还依赖一个高可用的、序列化的分布式锁服务组件,叫做 Chubby

一个 Chubby 服务包括了 5 个活动的副本,其中的一个副本被选为 Master,并且处理请求

只有在大多数副本都是正常运行的,并且彼此之间能够互相通信的情况下,Chubby 服务才是可用的

当有副本失效的时候,Chubby 使用 Paxos 算法来保证副本的一致性

Chubby 提供了一个名字空间,里面包括了目录和小文件。每个目录或者文件可以当成一个锁,读写文件的操作都是原子的

Chubby 客户程序库提供对 Chubby 文件的一致性缓存

每个Chubby 客户程序都维护一个与 Chubby 服务的会话。如果客户程序不能在租约到期的时间内重新签订会话的
租约,这个会话就过期失效了

当一个会话失效时,它拥有的锁和打开的文件句柄都失效了

Chubby 客户程序可以在文件和目录上注册回调函数,当文件或目录改变、或者会话过期时,回调函数会通知客户程序。
Bigtable 使用 Chubby 完成以下的几个任务:
1. 确保在任何给定的时间内最多只有一个活动的 Master 副本;
2. 存储 BigTable 数据的自引导指令的位置(参考 5.1 节);
3. 查找 Tablet 服务器,以及在 Tablet 服务器失效时进行善后(5.2 节)
;
4. 存储 BigTable 的模式信息(每张表的列族信息);
5. 以及存储访问控制列表。
如果 Chubby 长时间无法访问, BigTable 就会失效。
最近我们在使用 11 个 Chubby 服务实例的 14 个 BigTable
集群上测量了这个影响。由于 Chubby 不可用而导致 BigTable 中的部分数据不能访问的平均比率是 0.0047%
(Chubby 不能访问的原因可能是 Chubby 本身失效或者网络问题)。单个集群里,受 Chubby 失效影响最大的
百分比是 0.0326% 10 。


```