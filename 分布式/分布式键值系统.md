### 分布式键值系统
```
分布式键值模型可以看成是分布式表格模型的一种特例
由于它只支持针对单个key-value的增、删、查、改操作
```

### 名词解释
```
1、P2P
    对等网络(P2P)技术
    (1) C/S模式
        C/S模式中，数据的分发采用专门的服务器，多个客户端都从此服务器获取数据
        优点: 数据的一致性容易控制，系统也容易管理
        缺点: 单一失效点，资源限制，可扩展性差
    (2) P2P
        在P2P网络中，每个节点既可以从其他节点得到服务，也可以向其他节点提供服务
    (3) 组织结构
        1) DHT结构(分布式哈希表)
        2) 树形结构
        3) 网状结构

2、Gossip 协议

```

### Amazon Dynamo
```
// 数据分布
    > 一致性Hash(DHT)
        一个token是一个虚拟节点
        给系统中每个节点分配一个随机token，这些token构成一个哈希环。执行数据存放操作时，先计算主键的哈希值，然后存放到顺时针方向第一个大于或者等于该哈希值的token所在的节点
    > 异构型问题
        由于节点之间运算存在差异
        每个物理节点根据其性能的差异分配多个token
    > 自动负载均衡
        有3个节点 1(1, 4, 7), 2(2, 3, 8), 3(0, 5, 6)
        假设增加节点4，集群会分别将节点1和节点3的token 1和token 5迁移到节点4
        此时的节点token分配情况变为：1(4, 7), 2(2, 3, 8), 3(0,6), 4(1, 5)    
    > Gossip
        Dynamo无中心节点
        每个节点维护整个集群的信息(用于token节点和物理节点的定位)
        所有节点每隔固定时间(比如1s)通过Gossip协议的方式从其他节点中任意选择一个与之通信的节点。如果连接成功，双方交换各自保存的集群信息。
        新加入的节点首先与种子节点通信

// 一致性与复制
    为了处理节点失效的情况(DHT环中删除节点)，需要对节点的数据进行复制
    > 数据备份
        假设数据存储N份，DHT定位到的数据所属节点为K，则数据存储在节点K, K+1 ... K+N-1上
        如果第K+i(0≤i≤N-1)台机器宕机，则往后找一台机器K+N临时替代
    > 数据回传
        如果k+i重启，上面临时替代的机器K+N通过Gossip协议发现，它会将这些临时数据归还K+i
    > NWR
        一种一致性协议
        N表示复制的备份数，R指成功读操作的最少节点数，W指成功写操作的最少节点数
        当W+R>N的时候，整个系统对于客户端来讲能保证强一致性
        多读少些：设置W=N,R=1
        读写平衡：设置N=3，W=2，R=2
        注意：没有成功操作的节点会通过向量时钟来保证一致性
    > 向量时钟
        向量时钟用一个[nodes,counter]对表示
        nodes表示节点，counter是一个计数器


// 容错
    > 异常
        临时性的异常和永久性异常
    > 数据回传
        针对临时性异常
    > Merkle树同步
        针对永久性异常
        如果超过了时间T机器K+i还是处于宕机状态，这种异常是永久性的
        每个非叶子节点对应多个文件，为其所有子节点值组合以后的哈希值
        叶子节点对应单个数据文件，为文件内容的哈希值
        这样任意数据不匹配将导致根节点不同
    > 读取修复
        读取操作如果发现了某些副本版本太老，则启动异步的读取修复任务

// 负载均衡
    > 随机分配
        每台物理节点加入时根据其配置情况随机分配S个Token
    > 数据范围等分+随机分配

// 读写流程
    > 写数据
        > 根据一致性哈希算法计算出每个数据副本所在的存储节点，其中一个副本作为本次写操作的协调者
        > 协调者并发地往所有其他副本发送写请求，每个副本将接收到的数据写入本地，协调者也将数据写入本地
        > 当某个副本写入成功后，回复协调者
        > 如果发给某个副本的写请求失败，协调者会将它加入重试列表不断重试。等到W-1个副本回复写入成功后（即加上协调者共W个副本写入成功），协调者可以回复客户端写入成功
        > 协调者回复客户端成功后，还会继续等待或者重试，直到所有的副本都写入成功。
    > 读数据
        > 根据一致性哈希算法计算出每个副本所在的存储节点，其中一个副本作为本次读操作的协调者
        > 协调者根据负载策略选择R个副本，并发地向它们发送读请求
        > 每个副本读取本地数据，协调者也读取本地数据
        > 等到R个副本回复读取成功后，协调者可以回复客户端
            > 如果R个副本返回的数据完全一致，将某个副本的读取结果回复客户端
            > 否则，根据修改时间戳选择最新的数据，当然用户也可以自定义冲突处理方法。
        > 读取过程中如果发现某些副本上的数据版本太旧，Dynamo内部会异步发起一次读取修复操作
```

### 淘宝Tair
```
由一个中心控制节点和若干个服务节点组成

中心控制节点称为Config Server，服务节点称为Data Server

Config Server负责管理所有的Data Server，维护其状态信息，采用主备保证可靠性
Data Server对外提供各种数据服务，并以心跳的形式将自身状况汇报给Config Server

// 数据分布
    > 桶
        计算主键哈希值，分布到Q个桶中
        桶是负载均衡和数据迁移的基本单位
        Config Server按照一定的策略把每个桶指派到不同的Data Server上
        保证桶分布的均衡性，就能够保证数据分布的均衡性
        

```